<!doctype html><html lang=zh>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="ie=edge">
<title>harbor - 如创科技</title>
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=icon href=https://www.rutron.net/favicon.png>
<link rel=stylesheet href=/css/style.min.bed369b6636aa19e87512113b3caaa34b9db89c9c071f25efab970ae54757c9c.css>
</head>
<body class=page>
<div id=main-menu-mobile class=main-menu-mobile>
<ul>
<li class=menu-item-服务>
<a href=/services/>
<span>服务</span>
</a>
</li>
<li class=menu-item-关于>
<a href=/about/>
<span>关于</span>
</a>
</li>
<li class=menu-item-联系>
<a href=/contact/>
<span>联系</span>
</a>
</li>
</ul>
</div>
<div id=wrapper class=wrapper>
<div class="header header-absolute">
<div class=container>
<div class=logo>
<a href=https://www.rutron.net/><img height=40px width=40px alt=如创科技 src=/images/logo.png></a>
</div>
<div class=logo-mobile>
<a href=https://www.rutron.net/><img height=40px width=40px alt=如创科技 src=/images/logo.png></a>
</div>
<div id=main-menu class=main-menu>
<ul>
<li class=menu-item-服务>
<a href=/services/>
<span>服务</span>
</a>
</li>
<li class=menu-item-关于>
<a href=/about/>
<span>关于</span>
</a>
</li>
<li class=menu-item-联系>
<a href=/contact/>
<span>联系</span>
</a>
</li>
</ul>
</div>
<button id=toggle-main-menu-mobile class="hamburger hamburger--slider" type=button aria-label="Toggle Menu">
<span class=hamburger-box>
<span class=hamburger-inner></span>
</span>
</button>
</div>
</div>
<div class="container pt-10 pb-6">
<div class=row>
<div class=col-12>
<h1 class="title-1 black">harbor</h1>
</div>
</div>
</div>
<div class="container pb-6">
<div class=row>
<div class="col-12 col-md-6 mb-2"><blockquote>
<p>本文已参与「开源摘星计划」，欢迎正在阅读的你加入。活动链接：https://github.com/weopenprojects/WeOpen-Star</p>
</blockquote>
<h2 id=方案的选择>方案的选择</h2>
<p>分析了 <a href=https://github.com/goharbor/harbor/issues/3582>官方 Github: Harbor 高可用方案讨论</a>, 一开始我们选择了 Solution 1 (双激活共享存储方案), 在公司内部大概运行了一年多的时间, 架构图如下:</p>
<p><img src=images/harbor-dual-master-replication-ha/solution-1.png alt="Active-Active with scale out ability"></p>
<p>从图中可以看到, 这种方案基于外部共享存储、外部数据库和 Redis 服务, 构建其两个/以上的 harbor 实例. 既然使用了外部的服务, 那么高可用的压力自然而然的转移到了外部服务上. 我们一开始采用的外部的 NFS 共享存储服务, 由于我们团队实际情况, 我们暂时还不能保证外部存储的高可用. 同时, 鉴于我们对镜像服务高可用的迫切需求, 决定调研新的 Harbor 的高可用方案.</p>
<p>选择了 Solution 4 (双主复制方案), 这个解决方案, 使用复制来实现高可用, 它不需要共享存储、外部数据库服务、外部 Redis 服务. 这种方案可以有效的解决镜像服务的单点故障. 架构图如下:</p>
<p><img src=images/harbor-dual-master-replication-ha/solution-4.png alt=harbor-dual-master-replication-ha-solution></p>
<p>从图中可以看到, 这种方案仅需要在两个 harbor 实例之间建立全量复制机制. 这种方案特别适合异地办公的团队.</p>
<h2 id=环境>环境</h2>
<p>以下是服务器和各组件的详细情况:</p>
<table>
<thead>
<tr>
<th style=text-align:left>服务器配置</th>
<th style=text-align:left>值</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left>虚拟机</td>
<td style=text-align:left>2台</td>
</tr>
<tr>
<td style=text-align:left>IP/内网</td>
<td style=text-align:left>10.206.99.57, 10.206.99.58</td>
</tr>
<tr>
<td style=text-align:left>配置</td>
<td style=text-align:left>4核8G, 系统盘160G, 数据盘5T挂载到/data目录</td>
</tr>
<tr>
<td style=text-align:left>操作系统</td>
<td style=text-align:left>CentOS 7.9</td>
</tr>
<tr>
<td style=text-align:left>用户</td>
<td style=text-align:left>root</td>
</tr>
</tbody>
</table>
<blockquote>
<p>这里把数据磁盘挂到 <code>/data</code> 目录, 是因为 harbor 的数据卷配置默认就是它, 后面就不需要修改 harbor 这块的配置了.</p>
</blockquote>
<table>
<thead>
<tr>
<th style=text-align:left>组件</th>
<th style=text-align:left>配置/版本</th>
<th style=text-align:left>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left>docker-ce</td>
<td style=text-align:left>20.10.14</td>
<td></td>
</tr>
<tr>
<td style=text-align:left>docker-compose</td>
<td style=text-align:left>1.29.2</td>
<td style=text-align:left>最新稳定版</td>
</tr>
<tr>
<td style=text-align:left>harbor</td>
<td style=text-align:left>v2.2.4</td>
<td style=text-align:left>离线版</td>
</tr>
</tbody>
</table>
<h2 id=安装-docker>安装 docker</h2>
<p>参考 <a href=https://docs.docker.com/engine/install/centos/>Install Docker Engine on CentOS</a> 来安装, 因为我是全新的系统, 直接安装:</p>
<h3 id=安装-yum-仓库>安装 yum 仓库</h3>
<p>安装 <code>yum-utils</code> 包, 它能提供 <code>yum-config-manager</code> 配置工具, 然后用工具来配置安装稳定的 yum 仓库.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>yum install -y yum-utils
yum-config-manager <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --add-repo <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
</code></pre></div><blockquote>
<p>这里使用阿里云镜像替换 <a href=https://download.docker.com/linux/centos/docker-ce.repo>https://download.docker.com/linux/centos/docker-ce.repo</a></p>
</blockquote>
<h3 id=安装-docker-引擎>安装 docker 引擎</h3>
<p>安装最新稳定版 Docker 引擎和 containerd</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>yum install -y docker-ce docker-ce-cli containerd.io
</code></pre></div><p>启动 docker 实例并配置开机自动启动</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>systemctl start docker
systemctl enable docker
</code></pre></div><h3 id=优化-docker-配置>优化 docker 配置</h3>
<p>做一些 docker 相关的配置优化:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>cat <span style=color:#e6db74>&lt;&lt;EOF | tee /etc/docker/daemon.json
</span><span style=color:#e6db74>{
</span><span style=color:#e6db74>  &#34;exec-opts&#34;: [&#34;native.cgroupdriver=systemd&#34;],
</span><span style=color:#e6db74>  &#34;log-driver&#34;: &#34;json-file&#34;,
</span><span style=color:#e6db74>  &#34;log-opts&#34;: {
</span><span style=color:#e6db74>    &#34;max-size&#34;: &#34;100m&#34;
</span><span style=color:#e6db74>  },
</span><span style=color:#e6db74>  &#34;storage-driver&#34;: &#34;overlay2&#34;,
</span><span style=color:#e6db74>  &#34;storage-opts&#34;: [
</span><span style=color:#e6db74>    &#34;overlay2.override_kernel_check=true&#34;
</span><span style=color:#e6db74>  ]
</span><span style=color:#e6db74>}
</span><span style=color:#e6db74>EOF</span>
</code></pre></div><p>重启启动 docker 实例</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>systemctl daemon-reload
systemctl restart docker
</code></pre></div><h3 id=安装-docker-compose>安装 docker-compose</h3>
<p>harbor 使用 docker-compose 进行部署, 当前最新稳定版本是 1.29.2, 使用下面命令进行安装:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl -L <span style=color:#e6db74>&#34;https://github.com/docker/compose/releases/download/1.29.2/docker-compose-</span><span style=color:#66d9ef>$(</span>uname -s<span style=color:#66d9ef>)</span><span style=color:#e6db74>-</span><span style=color:#66d9ef>$(</span>uname -m<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> -o /usr/local/bin/docker-compose
<span style=color:#75715e># 如果你的服务器也是 Linux-x86_64, 可以用这个国内的地址下载</span>
curl -L <span style=color:#e6db74>&#34;https://rutron.oss-cn-beijing.aliyuncs.com/tools/docker-compose-Linux-x86_64&#34;</span> -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose
</code></pre></div><h2 id=安装-harbor-实例>安装 Harbor 实例</h2>
<p>打开 <a href=https://github.com/goharbor/harbor/releases>Harbor 下载页面</a>, 下载离线安装器. 因为之前使用的是 <code>v2.2.0</code> 版本, 有不少应用已经对接了 harbor 的 api, 为了兼容性, 我选择了 <code>v2.2.4</code>.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># 使用 root 用户 ~ 目录</span>
cd /root
curl -O https://rutron.oss-cn-beijing.aliyuncs.com/harbor/harbor-offline-installer-v2.2.4.tgz
tar xzvf harbor-offline-installer-v2.2.4.tgz
cd harbor
</code></pre></div><blockquote>
<p>由于 github-releases 下载页面速度很慢, 我将下载好的包放在了 aliyun-oss 上</p>
</blockquote>
<h3 id=配置文件>配置文件</h3>
<p>拷贝示例配置文件, 进行修改:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>cp harbor.yml.tmpl harbor.yml
vi harbor.yml
</code></pre></div><p>因为我打算采用默认安装, 所以需要修改的配置项不多, 仅有几个地方需要修改:</p>
<ul>
<li><strong>hostname:</strong> 访问 harbor admin ui 和镜像服务的 hostname 或者 ip</li>
<li><strong>https:</strong>
<ul>
<li><strong>certificate:</strong> 线上服务基本都需要要开通 https, 为 https 配置证书路径</li>
<li><strong>private_key:</strong> 为 https 配置私钥路径</li>
</ul>
</li>
<li><strong>external_url:</strong> 如果要把 harbor 放在代理的后面, 比如请求会通过 nginx/f5 的代理转发才会到 harbor, 就需要配置该项. 如配置了该项, 上面的 <code>hostname</code> 配置就会失效.</li>
<li><strong>database.paasword:</strong> 数据库密码, 线上环境必须修改</li>
<li><strong>data_volume:</strong> 这是 harbor 的数据目录, 默认是 <code>/data</code>, 因为我服务器的数据盘就挂的 <code>/data</code> 目录, 这里就不需要修改了.</li>
</ul>
<p>下面是默认配置文件, 重点配置我都做了翻译。别看配置文件这么长，重要的都在前 50 行:</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">120
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">121
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">122
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">123
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">124
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">125
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">126
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">127
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">128
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">129
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">130
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">131
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">132
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">133
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">134
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">135
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">136
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">137
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">138
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">139
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">140
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">141
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">142
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">143
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">144
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">145
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">146
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">147
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">148
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">149
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">150
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">151
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">152
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">153
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">154
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">155
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">156
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">157
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">158
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">159
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">160
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">161
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">162
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">163
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">164
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">165
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">166
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">167
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">168
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">169
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">170
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">171
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">172
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">173
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">174
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">175
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">176
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">177
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">178
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">179
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">180
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">181
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">182
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">183
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">184
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">185
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">186
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">187
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">188
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">189
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">190
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">191
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">192
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">193
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">194
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">195
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">196
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">197
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">198
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">199
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">200
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">201
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">202
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">203
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">204
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">205
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">206
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># Harbor 配置文件</span>

<span style=color:#75715e># 访问管理端 UI 和容器镜像服务使用的 IP 地址或者 hostname</span>
<span style=color:#75715e># 禁止使用 localhost 或 127.0.0.1, 因为 Harbor 需要被外部客户端访问</span>
<span style=color:#f92672>hostname</span>: <span style=color:#ae81ff>reg.mydomain.com</span>

<span style=color:#75715e># http related config</span>
<span style=color:#f92672>http</span>:
  <span style=color:#75715e># port for http, default is 80. If https enabled, this port will redirect to https port</span>
  <span style=color:#f92672>port</span>: <span style=color:#ae81ff>80</span>

<span style=color:#75715e># https 相关配置</span>
<span style=color:#f92672>https</span>:
  <span style=color:#75715e># harbor https 端口, 默认 443</span>
  <span style=color:#f92672>port</span>: <span style=color:#ae81ff>443</span>
  <span style=color:#75715e># nginx 证书和私钥路径</span>
  <span style=color:#f92672>certificate</span>: <span style=color:#ae81ff>/your/certificate/path</span>
  <span style=color:#f92672>private_key</span>: <span style=color:#ae81ff>/your/private/key/path</span>

<span style=color:#75715e># # Uncomment following will enable tls communication between all harbor components</span>
<span style=color:#75715e># internal_tls:</span>
<span style=color:#75715e>#   # set enabled to true means internal tls is enabled</span>
<span style=color:#75715e>#   enabled: true</span>
<span style=color:#75715e>#   # put your cert and key files on dir</span>
<span style=color:#75715e>#   dir: /etc/harbor/tls/internal</span>

<span style=color:#75715e># 取消注释会开启外部代理</span>
<span style=color:#75715e># 如开启了该配置, 就不会使用 hostname 了</span>
<span style=color:#75715e># external_url: https://reg.mydomain.com:8433</span>

<span style=color:#75715e># Harbor 管理后台初始密码</span>
<span style=color:#75715e># 仅第一次安装 harbor 时有用</span>
<span style=color:#75715e># 登录 harbor 管理后台之后, 记得修改 admin 密码</span>
<span style=color:#f92672>harbor_admin_password</span>: <span style=color:#ae81ff>Harbor12345</span>

<span style=color:#75715e># Harbor 数据库配置</span>
<span style=color:#f92672>database</span>:
  <span style=color:#75715e># Harbor 数据库 root 用户的密码</span>
  <span style=color:#75715e># 上生产环境, 必须要修改</span>
  <span style=color:#f92672>password</span>: <span style=color:#ae81ff>root123</span>
  <span style=color:#75715e># 空闲连接池中的最大连接数量</span>
  <span style=color:#75715e># 如果 &lt;=0 表示不保留任何空闲连接</span>
  <span style=color:#f92672>max_idle_conns</span>: <span style=color:#ae81ff>50</span>
  <span style=color:#75715e># 数据库开启的最大连接数</span>
  <span style=color:#75715e># 如果 &lt;=0, 表示不限制打开连接数</span>
  <span style=color:#75715e># 注意: harbor 使用的 postgres 该配置默认是 1024</span>
  <span style=color:#f92672>max_open_conns</span>: <span style=color:#ae81ff>1000</span>

<span style=color:#75715e># 默认数据卷</span>
<span style=color:#f92672>data_volume</span>: <span style=color:#ae81ff>/data</span>

<span style=color:#75715e># Harbor Storage settings by default is using /data dir on local filesystem</span>
<span style=color:#75715e># Uncomment storage_service setting If you want to using external storage</span>
<span style=color:#75715e># storage_service:</span>
<span style=color:#75715e>#   # ca_bundle is the path to the custom root ca certificate, which will be injected into the truststore</span>
<span style=color:#75715e>#   # of registry&#39;s and chart repository&#39;s containers.  This is usually needed when the user hosts a internal storage with self signed certificate.</span>
<span style=color:#75715e>#   ca_bundle:</span>

<span style=color:#75715e>#   # storage backend, default is filesystem, options include filesystem, azure, gcs, s3, swift and oss</span>
<span style=color:#75715e>#   # for more info about this configuration please refer https://docs.docker.com/registry/configuration/</span>
<span style=color:#75715e>#   filesystem:</span>
<span style=color:#75715e>#     maxthreads: 100</span>
<span style=color:#75715e>#   # set disable to true when you want to disable registry redirect</span>
<span style=color:#75715e>#   redirect:</span>
<span style=color:#75715e>#     disabled: false</span>

<span style=color:#75715e># Trivy configuration</span>
<span style=color:#75715e>#</span>
<span style=color:#75715e># Trivy DB contains vulnerability information from NVD, Red Hat, and many other upstream vulnerability databases.</span>
<span style=color:#75715e># It is downloaded by Trivy from the GitHub release page https://github.com/aquasecurity/trivy-db/releases and cached</span>
<span style=color:#75715e># in the local file system. In addition, the database contains the update timestamp so Trivy can detect whether it</span>
<span style=color:#75715e># should download a newer version from the Internet or use the cached one. Currently, the database is updated every</span>
<span style=color:#75715e># 12 hours and published as a new release to GitHub.</span>
<span style=color:#f92672>trivy</span>:
  <span style=color:#75715e># ignoreUnfixed The flag to display only fixed vulnerabilities</span>
  <span style=color:#f92672>ignore_unfixed</span>: <span style=color:#66d9ef>false</span>
  <span style=color:#75715e># skipUpdate The flag to enable or disable Trivy DB downloads from GitHub</span>
  <span style=color:#75715e>#</span>
  <span style=color:#75715e># You might want to enable this flag in test or CI/CD environments to avoid GitHub rate limiting issues.</span>
  <span style=color:#75715e># If the flag is enabled you have to download the `trivy-offline.tar.gz` archive manually, extract `trivy.db` and</span>
  <span style=color:#75715e># `metadata.json` files and mount them in the `/home/scanner/.cache/trivy/db` path.</span>
  <span style=color:#f92672>skip_update</span>: <span style=color:#66d9ef>false</span>
  <span style=color:#75715e>#</span>
  <span style=color:#75715e># insecure The flag to skip verifying registry certificate</span>
  <span style=color:#f92672>insecure</span>: <span style=color:#66d9ef>false</span>
  <span style=color:#75715e># github_token The GitHub access token to download Trivy DB</span>
  <span style=color:#75715e>#</span>
  <span style=color:#75715e># Anonymous downloads from GitHub are subject to the limit of 60 requests per hour. Normally such rate limit is enough</span>
  <span style=color:#75715e># for production operations. If, for any reason, it&#39;s not enough, you could increase the rate limit to 5000</span>
  <span style=color:#75715e># requests per hour by specifying the GitHub access token. For more details on GitHub rate limiting please consult</span>
  <span style=color:#75715e># https://developer.github.com/v3/#rate-limiting</span>
  <span style=color:#75715e>#</span>
  <span style=color:#75715e># You can create a GitHub token by following the instructions in</span>
  <span style=color:#75715e># https://help.github.com/en/github/authenticating-to-github/creating-a-personal-access-token-for-the-command-line</span>
  <span style=color:#75715e>#</span>
  <span style=color:#75715e># github_token: xxx</span>

<span style=color:#f92672>jobservice</span>:
  <span style=color:#75715e># Maximum number of job workers in job service</span>
  <span style=color:#f92672>max_job_workers</span>: <span style=color:#ae81ff>10</span>

<span style=color:#f92672>notification</span>:
  <span style=color:#75715e># Maximum retry count for webhook job</span>
  <span style=color:#f92672>webhook_job_max_retry</span>: <span style=color:#ae81ff>10</span>

<span style=color:#f92672>chart</span>:
  <span style=color:#75715e># Change the value of absolute_url to enabled can enable absolute url in chart</span>
  <span style=color:#f92672>absolute_url</span>: <span style=color:#ae81ff>disabled</span>

<span style=color:#75715e># 日志配置</span>
<span style=color:#f92672>log</span>:
  <span style=color:#75715e># 可选项 debug, info, warning, error, fatal</span>
  <span style=color:#f92672>level</span>: <span style=color:#ae81ff>info</span>
  <span style=color:#75715e># 使用 local 存储的日志相关配置</span>
  <span style=color:#f92672>local</span>:
    <span style=color:#75715e># 日志轮转文件数量</span>
    <span style=color:#75715e># 日志文件在被删除之前会轮转 rotate_count 次</span>
    <span style=color:#75715e># 如果 0 则删除旧版本而不是轮换。</span>
    <span style=color:#f92672>rotate_count</span>: <span style=color:#ae81ff>50</span>
    <span style=color:#75715e># 当日志文件大于 rotate_size 个字节 bytes 时会轮换</span>
    <span style=color:#75715e># 如果 size 后跟 k 则表示以 kb 为单位, 也可以跟 M/G</span>
    <span style=color:#75715e># 所以 100/100k/100M/200G 都是合法的</span>
    <span style=color:#f92672>rotate_size</span>: <span style=color:#ae81ff>200M</span>
    <span style=color:#75715e># 存储日志的主机目录</span>
    <span style=color:#f92672>location</span>: <span style=color:#ae81ff>/var/log/harbor</span>

  <span style=color:#75715e># Uncomment following lines to enable external syslog endpoint.</span>
  <span style=color:#75715e># external_endpoint:</span>
  <span style=color:#75715e>#   # protocol used to transmit log to external endpoint, options is tcp or udp</span>
  <span style=color:#75715e>#   protocol: tcp</span>
  <span style=color:#75715e>#   # The host of external endpoint</span>
  <span style=color:#75715e>#   host: localhost</span>
  <span style=color:#75715e>#   # Port of external endpoint</span>
  <span style=color:#75715e>#   port: 5140</span>

<span style=color:#75715e>#This attribute is for migrator to detect the version of the .cfg file, DO NOT MODIFY!</span>
<span style=color:#f92672>_version</span>: <span style=color:#ae81ff>2.2.0</span>

<span style=color:#75715e># Uncomment external_database if using external database.</span>
<span style=color:#75715e># external_database:</span>
<span style=color:#75715e>#   harbor:</span>
<span style=color:#75715e>#     host: harbor_db_host</span>
<span style=color:#75715e>#     port: harbor_db_port</span>
<span style=color:#75715e>#     db_name: harbor_db_name</span>
<span style=color:#75715e>#     username: harbor_db_username</span>
<span style=color:#75715e>#     password: harbor_db_password</span>
<span style=color:#75715e>#     ssl_mode: disable</span>
<span style=color:#75715e>#     max_idle_conns: 2</span>
<span style=color:#75715e>#     max_open_conns: 0</span>
<span style=color:#75715e>#   notary_signer:</span>
<span style=color:#75715e>#     host: notary_signer_db_host</span>
<span style=color:#75715e>#     port: notary_signer_db_port</span>
<span style=color:#75715e>#     db_name: notary_signer_db_name</span>
<span style=color:#75715e>#     username: notary_signer_db_username</span>
<span style=color:#75715e>#     password: notary_signer_db_password</span>
<span style=color:#75715e>#     ssl_mode: disable</span>
<span style=color:#75715e>#   notary_server:</span>
<span style=color:#75715e>#     host: notary_server_db_host</span>
<span style=color:#75715e>#     port: notary_server_db_port</span>
<span style=color:#75715e>#     db_name: notary_server_db_name</span>
<span style=color:#75715e>#     username: notary_server_db_username</span>
<span style=color:#75715e>#     password: notary_server_db_password</span>
<span style=color:#75715e>#     ssl_mode: disable</span>

<span style=color:#75715e># Uncomment external_redis if using external Redis server</span>
<span style=color:#75715e># external_redis:</span>
<span style=color:#75715e>#   # support redis, redis+sentinel</span>
<span style=color:#75715e>#   # host for redis: &lt;host_redis&gt;:&lt;port_redis&gt;</span>
<span style=color:#75715e>#   # host for redis+sentinel:</span>
<span style=color:#75715e>#   #  &lt;host_sentinel1&gt;:&lt;port_sentinel1&gt;,&lt;host_sentinel2&gt;:&lt;port_sentinel2&gt;,&lt;host_sentinel3&gt;:&lt;port_sentinel3&gt;</span>
<span style=color:#75715e>#   host: redis:6379</span>
<span style=color:#75715e>#   password:</span>
<span style=color:#75715e>#   # sentinel_master_set must be set to support redis+sentinel</span>
<span style=color:#75715e>#   #sentinel_master_set:</span>
<span style=color:#75715e>#   # db_index 0 is for core, it&#39;s unchangeable</span>
<span style=color:#75715e>#   registry_db_index: 1</span>
<span style=color:#75715e>#   jobservice_db_index: 2</span>
<span style=color:#75715e>#   chartmuseum_db_index: 3</span>
<span style=color:#75715e>#   trivy_db_index: 5</span>
<span style=color:#75715e>#   idle_timeout_seconds: 30</span>

<span style=color:#75715e># Uncomment uaa for trusting the certificate of uaa instance that is hosted via self-signed cert.</span>
<span style=color:#75715e># uaa:</span>
<span style=color:#75715e>#   ca_file: /path/to/ca</span>

<span style=color:#75715e># Global proxy</span>
<span style=color:#75715e># Config http proxy for components, e.g. http://my.proxy.com:3128</span>
<span style=color:#75715e># Components doesn&#39;t need to connect to each others via http proxy.</span>
<span style=color:#75715e># Remove component from `components` array if want disable proxy</span>
<span style=color:#75715e># for it. If you want use proxy for replication, MUST enable proxy</span>
<span style=color:#75715e># for core and jobservice, and set `http_proxy` and `https_proxy`.</span>
<span style=color:#75715e># Add domain to the `no_proxy` field, when you want disable proxy</span>
<span style=color:#75715e># for some special registry.</span>
<span style=color:#f92672>proxy</span>:
  <span style=color:#f92672>http_proxy</span>:
  <span style=color:#f92672>https_proxy</span>:
  <span style=color:#f92672>no_proxy</span>:
  <span style=color:#f92672>components</span>:
    - <span style=color:#ae81ff>core</span>
    - <span style=color:#ae81ff>jobservice</span>
    - <span style=color:#ae81ff>trivy</span>

<span style=color:#75715e># metric:</span>
<span style=color:#75715e>#   enabled: false</span>
<span style=color:#75715e>#   port: 9090</span>
<span style=color:#75715e>#   path: /metrics</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=默认安装>默认安装</h3>
<p>默认安装不含 Notary, Trivy, 或者 Chart 仓库服务, 执行下面的命令:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>./install.sh
</code></pre></div><p>查看安装状态:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>docker ps
</code></pre></div><p>如果所有的容器的状态 STATUS 都为 <code>Up About a minute (healthy)</code> 说明安装成功~<br>
打开 harbor admin ui 验证下吧! 别忘了修改 admin 的密码. 使用同样的方式将两台虚拟机的 docker、docker-compose 和 harbor 都安装好.</p>
<h3 id=更改配置>更改配置</h3>
<p>如果需要更改 harbor 的配置, 请按照如下步骤操作:</p>
<ol>
<li>停止 harbor</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># 首先进入工作目录</span>
cd ~/harbor/
docker-compose down -v
</code></pre></div><ol start=2>
<li>更新配置文件</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>vim harbor.yml
</code></pre></div><ol start=3>
<li>运行脚本生成最终配置</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>./prepare
</code></pre></div><ol start=4>
<li>重新启动 harbor 实例</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>docker-compose up -d
</code></pre></div><ol start=5>
<li>其他命令</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># 重装前清理历史数据</span>
rm -rf /data/database
rm -rf /data/registry
rm -rf /data/redis
</code></pre></div><h2 id=配置双主复制>配置双主复制</h2>
<p>在其中一台 harbor 实例上配置，我以 10.206.99.58 为例，另一实例同理，首先需要创建仓库，点击<code>系统管理>仓库管理>新建目标</code>，按照如下填写：</p>
<p><img src=images/harbor-dual-master-replication-ha/add-harbor-instance.png alt=add-harbor-instance></p>
<p>然后，创建复制规则，点击<code>系统管理>复制管理>新建规则</code>，按照如下填写：</p>
<p><img src=images/harbor-dual-master-replication-ha/add-replication-rule.png alt=add-replication-rule></p>
<p>这样，当用户往 10.206.99.58 中推送/删除镜像时，10.206.99.57 也会同步发生变化。</p>
<h2 id=增加反向代理>增加反向代理</h2>
<p>现在两个 harbor 实例都已经配置好了。用户看到的是两个完全独立的 harbor，他们的用户独立，访问地址不同。当然有些场景下这样已经可以满足需求了，比如异地办公的团队（可以按照地域区分使用访问地址）。如果我们想统一访问地址，可以在前面增加一个反向代理。而且可以将 ssl 证书部署在代理上。还是比较推荐的。所以我希望这个代理能实现：</p>
<ol>
<li><strong>统一的访问入口：</strong> 将两个 harbor 地址统一为一个。</li>
<li><strong>卸载 ssl 证书：</strong> 这将简化 harbor 实例的配置，更易于证书的管理。</li>
<li><strong>会话保持：</strong> 因为 harbor 之间复制是有时间差的，用户往一个实例中推送镜像之后不可能立即在另一实例中拉取到，所以要将客户端的请求固定到一个实例上。</li>
</ol>
<blockquote>
<p>但是很遗憾，harbor 实例之间用户和相关权限是无法同步的。这可能需要需要一些外在的机制实现了。</p>
</blockquote>
<p>我假设提供给用户的域名是：registry.example.com，我使用 nginx 作为这个反向代理，它的配置文件<code>/etc/nginx/conf.d/registry.example.com.conf</code>是这样的。</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=color:#66d9ef>upstream</span> <span style=color:#e6db74>harbor</span>{
    <span style=color:#f92672>ip_hash</span>;
    <span style=color:#f92672>server</span> <span style=color:#ae81ff>10</span><span style=color:#e6db74>.206.99.57</span>;
    <span style=color:#f92672>server</span> <span style=color:#ae81ff>10</span><span style=color:#e6db74>.206.99.58</span>;
}

<span style=color:#66d9ef>server</span> {
    <span style=color:#f92672>listen</span> <span style=color:#ae81ff>80</span>;
    <span style=color:#f92672>server_name</span> <span style=color:#e6db74>registry.example.com</span>;
    <span style=color:#f92672>rewrite</span> <span style=color:#e6db74>^(.*)</span>$ <span style=color:#e6db74>https://</span>$host$1;
}

<span style=color:#66d9ef>server</span> {
    <span style=color:#f92672>listen</span> <span style=color:#ae81ff>443</span> <span style=color:#e6db74>ssl</span>;
    <span style=color:#f92672>server_name</span> <span style=color:#e6db74>registry.example.com</span>;

    <span style=color:#f92672>charset</span> <span style=color:#e6db74>utf-8</span>;
    <span style=color:#f92672>client_max_body_size</span> <span style=color:#ae81ff>0</span>;
    <span style=color:#f92672>client_header_timeout</span> <span style=color:#ae81ff>180</span>;
    <span style=color:#f92672>client_body_timeout</span> <span style=color:#ae81ff>180</span>;
    <span style=color:#f92672>send_timeout</span> <span style=color:#ae81ff>180</span>;
    
    <span style=color:#f92672>ssl_certificate</span> <span style=color:#e6db74>/etc/nginx/conf.d/cert/registry_example_com.pem</span>;
    <span style=color:#f92672>ssl_certificate_key</span> <span style=color:#e6db74>/etc/nginx/conf.d/cert/registry_example_com.key</span>;
    <span style=color:#f92672>ssl_session_timeout</span> <span style=color:#ae81ff>5m</span>;
    <span style=color:#f92672>ssl_ciphers</span> <span style=color:#e6db74>ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4:!DH:!DHE</span>;
    <span style=color:#f92672>ssl_protocols</span> <span style=color:#e6db74>TLSv1</span> <span style=color:#e6db74>TLSv1.1</span> <span style=color:#e6db74>TLSv1.2</span> <span style=color:#e6db74>TLSv1.3</span>;
    <span style=color:#f92672>ssl_prefer_server_ciphers</span> <span style=color:#66d9ef>on</span>;

    <span style=color:#f92672>proxy_http_version</span> <span style=color:#ae81ff>1</span><span style=color:#e6db74>.1</span>;
    <span style=color:#f92672>proxy_connect_timeout</span> <span style=color:#ae81ff>900</span>;
    <span style=color:#f92672>proxy_send_timeout</span> <span style=color:#ae81ff>900</span>;
    <span style=color:#f92672>proxy_read_timeout</span> <span style=color:#ae81ff>900</span>;
    <span style=color:#f92672>proxy_buffering</span> <span style=color:#66d9ef>off</span>;
    <span style=color:#f92672>proxy_request_buffering</span> <span style=color:#66d9ef>off</span>;
    <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>X-Real-IP</span> $remote_addr;
    <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>X-Forwarded-For</span> $proxy_add_x_forwarded_for;

    <span style=color:#75715e># 如果harbor实例仅配置了ip类型的hostname这里就不用配置了
</span><span style=color:#75715e></span>    <span style=color:#75715e># 如果配置了可解析的hostname/external_url需要打开注释
</span><span style=color:#75715e></span>    <span style=color:#75715e># proxy_set_header Host $host;
</span><span style=color:#75715e></span>
    <span style=color:#75715e># 如果external_url中使用https但是代理访问harbor使用http需要打开注释
</span><span style=color:#75715e></span>    <span style=color:#75715e># 同时去掉harbor实例内部的nginx相关的$scheme配置
</span><span style=color:#75715e></span>    <span style=color:#75715e># proxy_set_header X-Forwarded-Proto $scheme;
</span><span style=color:#75715e></span>
    <span style=color:#f92672>location</span> <span style=color:#e6db74>/</span> {
        <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://harbor</span>;
    }
}
</code></pre></td></tr></table>
</div>
</div><p>运行 nginx 反向代理：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># 将证书和配置文件都放在 /etc/nginx/conf.d 路径下</span>
docker run -d --restart<span style=color:#f92672>=</span>always <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --name<span style=color:#f92672>=</span>nginx <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    -p 80:80 -p 443:443 <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    -v /etc/nginx/conf.d:/etc/nginx/conf.d <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    nginx
</code></pre></div><p>测试对 registry.example.com 进行<code>login/push/pull</code>镜像均正常，检查两个 harbor 实例也同步正常。至此，完成～</p>
<h2 id=总结>总结</h2>
<p>至此，所有的安装/配置就结束了，通过体验测试我发现：</p>
<ol>
<li><strong>用户是独立的</strong><br>
两个实例之间的项目、镜像、标签相关资源是可以同步的，但是用户不可以。如果用户要在两个实例直接切换使用的话，需要分别登录两个 harbor admin ui 为用户创建两个相同的账号。所以说该方案比较适合异地办公团队，仅做镜像数据的同步。</li>
<li><strong>镜像同步有一定的时间差</strong><br>
我的两个实例是所在虚拟机在一个网段内的，测试了一个约 900M 的镜像，从开始同步到结束大概是10秒种。如果用户在一台实例上推送之后，立马去另一台实例上拉去是不行的。所以如果两个实例前面要增加 http 代理的话，需要使用 ip_hash 负载均衡策略，将用户请求固定到其中一台实例上。</li>
<li><strong>实例 url 地址不一致</strong><br>
这个问题不严重，因为是两个实例，如果我们在他们前面再部署 http 代理的话，就是三个地址。所以，两个实例对应 admin ui 上的 url 地址和用户使用的（如果有代理）url 地址都不一样。 比如：
<img src=images/harbor-dual-master-replication-ha/harbor-url.jpg alt=harbor-url.jpg></li>
</ol>
</div>
</div>
</div>
</div>
<div class=footer>
<div class=container>
<div class=row>
<div class=col-12>
<div class=footer-inner>
<ul class=social>
<li><a href=https://github.com/llaoj target=blank><img width=20 height=20 src=/social/github.svg title=Github alt=Github></a></li>
</ul>
<ul class=footer-menu>
<li><a href=https://www.rutron.net/>Home</a></li>
<li><a href=https://www.rutron.net/contact>Contact</a></li>
<li class=copyright>© 2022 如创科技</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class=sub-footer>
<div class=container>
<div class=row>
<div class=col-12>
<div class=sub-footer-inner>
<ul>
<li><strong>Phone: </strong>15666139166</li>
<li><strong>Email: </strong><a href=mailto:rutronnet@163.com>rutronnet@163.com</a></li>
</ul>
<ul>
<li class=zerostatic><a href=https://beian.miit.gov.cn/#/Integrated/index>鲁ICP备2021035257号-1</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
<script type=text/javascript src=/js/scripts.min.98ee06cc35517b5800b382aecb0fc59893e95b9c11dd21842d0d57e4f68043e3.js></script>
</body>
</html>